# Backend Data Structure

## Firestore Collections Hierarchy

```
Root
├── users/{userId}
│   ├── students/{studentId}
│   ├── student_timetables/{timetableId}
│   ├── attendance_records/{recordId}
│   ├── student_attendance_records/{recordId}
│   ├── attendance_check_links/{linkId}
│   ├── attendance_student_pins/{studentId}
│   ├── shared_schedules/{scheduleId}
│   ├── schedule_contributions/{contributionId}
│   ├── seats/{seatId}
│   ├── seat_assignments/{assignmentId}
│   ├── seat_layouts/{layoutId}
│   ├── class_sections/{sectionId}
│   ├── attendance_summaries/{summaryId}
│   └── settings/preferences
└── user_backups/{backupId}
```

---

## Collection Details

### Root Level Collections

#### `users/{userId}`
사용자 프로필 정보
```typescript
{
  authUid: string                           // Firebase Auth UID
  name: string                              // 사용자 이름
  email: string                             // 이메일
  profilePicture?: string                   // 프로필 사진 URL (optional)
  googleId: string                          // Google ID
  isActive: boolean                         // 활성 상태
  createdAt: Timestamp                      // 생성일시
  updatedAt: Timestamp                      // 수정일시
}
```

#### `user_backups/{backupId}`
사용자 데이터 백업
```typescript
{
  userId: string                            // 사용자 ID
  userProfile: User                         // 사용자 프로필 객체
  collections: {                            // 모든 컬렉션 데이터
    [collectionName: string]: Array<{
      id: string
      data: any
    }>
  }
  createdAt: Timestamp                      // 백업 생성일시
  backupType: "full_backup"                 // 백업 타입
}
```

---

### User Subcollections (`users/{userId}/...`)

#### `students/{studentId}`
학생 정보
```typescript
{
  id: string                                // 학생 ID (문서 ID와 동일)
  name: string                              // 이름
  email: string                             // 이메일
  grade: string                             // 학년
  school?: string                           // 학교명 (optional)
  phone?: string                            // 전화번호 (optional)
  parentName?: string                       // 학부모 이름 (optional)
  parentPhone?: string                      // 학부모 전화번호 (optional)
  address?: string                          // 주소 (optional)
  status: "active" | "withdrawn"            // 재학 상태
  enrollmentDate: Timestamp                 // 등록일
  withdrawalDate?: Timestamp                // 탈퇴일 (optional)
  isActive: boolean                         // 활성 상태 (하위 호환성)
  createdAt: Timestamp                      // 생성일시
  updatedAt: Timestamp                      // 수정일시
  userId: string                            // 소유자 ID
}
```

#### `student_timetables/{timetableId}`
학생별 시간표 (2-layer 구조)
```typescript
{
  id: string                                // 시간표 ID
  studentId: string                         // 학생 ID
  studentName: string                       // 학생 이름
  name: string                              // 시간표 이름
  description?: string                      // 설명 (optional)

  // 1차 레이어: 등원/하원 기본 틀
  basicSchedule: {
    dailySchedules: {
      [dayOfWeek: string]: {                // "monday", "tuesday", ...
        arrivalTime: string                 // "HH:mm" 형식
        departureTime: string               // "HH:mm" 형식
        isActive: boolean                   // 해당 요일 활성화 여부
      }
    }
    timeSlotInterval: number                // 시간 슬롯 간격 (분)
  }

  // 2차 레이어: 구체적인 일정
  detailedSchedule: {
    [dayOfWeek: string]: {
      timeSlots: [
        {
          id: string                        // 슬롯 ID
          startTime: string                 // "HH:mm" 형식
          endTime: string                   // "HH:mm" 형식
          subject: string                   // 과목명
          type: "class" | "self_study" | "external"  // 슬롯 유형
          isAutoGenerated: boolean          // 자동 생성 여부
          color?: string                    // 색상 코드 (optional)
          teacher?: string                  // 교사명 (optional)
          location?: string                 // 장소 (optional)
          notes?: string                    // 메모 (optional)
        }
      ]
    }
  }

  // 자동 채우기 설정
  autoFillSettings: {
    enabled: boolean                        // 자동 채우기 활성화
    defaultSubject: string                  // 기본 과목명
    fillEmptySlots: boolean                 // 빈 슬롯 채우기
  }

  // 버전 관리
  version: string                           // UUID 또는 타임스탬프 기반
  lastUpdatedAt: Timestamp                  // 마지막 수정일시
  lastUpdatedBy: "admin" | "student"        // 마지막 수정자

  isActive: boolean                         // 활성 상태
  isDefault: boolean                        // 기본 시간표 여부
  createdAt: Timestamp                      // 생성일시
  updatedAt: Timestamp                      // 수정일시
  userId: string                            // 소유자 ID
}
```

#### `attendance_records/{recordId}`
관리자 자가 출석 기록
```typescript
{
  date: string                              // "YYYY-MM-DD" 형식
  status: "present" | "absent" | "late" | "early_leave"  // 출석 상태
  seatId?: string                           // 좌석 ID (optional)
  checkInTime?: Timestamp                   // 입실 시각 (optional)
  checkOutTime?: Timestamp                  // 퇴실 시각 (optional)
  notes?: string                            // 메모 (optional)
  createdAt: Timestamp                      // 생성일시
  updatedAt: Timestamp                      // 수정일시
}
```


#### `student_attendance_records/{recordId}`
학생 출석 기록 (세션 기반)
```typescript
/*
*   현재 student_attendance_records -> 단일 필드에 존재
*   student_attendance_records -> 단일 필드에 존재 x, 
*/
{
  id: string                                // 기록 ID
  userId: string                            // 소유자 ID
  studentId: string                         // 학생 ID
  studentName: string                       // 학생 이름
  seatLayoutId: string                      // 좌석 레이아웃 ID
  seatId: string                            // 좌석 ID
  seatNumber: string                        // 좌석 번호
  date: string                              // "YYYY-MM-DD" 형식
  dayOfWeek: "monday" | "tuesday" | ... | "sunday"  // 요일

  // 예상 시간
  expectedArrivalTime: string               // "HH:mm" 형식
  expectedDepartureTime: string             // "HH:mm" 형식

  // 실제 시간
  actualArrivalTime?: Timestamp             // 실제 등원 시각 (optional)
  actualDepartureTime?: Timestamp           // 실제 하원 시각 (optional)

  // 상태
  status: "checked_in" | "checked_out" | "not_arrived" | "absent_excused" | "absent_unexcused"

  // 사유 결석 정보
  excusedReason?: string                    // 사유 (optional)
  excusedNote?: string                      // 상세 설명 (optional)
  excusedBy?: string                        // 처리자 (optional)

  // 지각/조퇴 정보
  isLate: boolean                           // 지각 여부
  isEarlyLeave: boolean                     // 조퇴 여부
  lateMinutes?: number                      // 지각 시간(분) (optional)
  earlyLeaveMinutes?: number                // 조퇴 시간(분) (optional)

  // 체크 방법
  checkInMethod?: "pin" | "manual" | "admin"     // 입실 방법 (optional)
  checkOutMethod?: "pin" | "manual" | "admin"    // 퇴실 방법 (optional)

  notes?: string                            // 메모 (optional)

  // 세션 관리
  sessionNumber: number                     // 당일 세션 번호 (1, 2, 3, ...)
  isLatestSession: boolean                  // 최신 세션 여부

  createdAt: Timestamp                      // 생성일시
  updatedAt: Timestamp                      // 수정일시
  recordTimestamp: Timestamp                // 기록 시각
}
```

#### `attendance_check_links/{linkId}`
출석 체크 공유 링크
```typescript
{
  id: string                                // 링크 ID
  userId: string                            // 소유자 ID
  linkToken: string                         // UUID 토큰
  linkUrl: string                           // 전체 URL
  seatLayoutId: string                      // 좌석 레이아웃 ID
  seatLayoutName: string                    // 좌석 레이아웃 이름
  title: string                             // 링크 제목
  description?: string                      // 설명 (optional)
  isActive: boolean                         // 활성 상태
  expiresAt?: Timestamp                     // 만료일시 (optional)
  usageCount: number                        // 사용 횟수
  createdAt: Timestamp                      // 생성일시
  updatedAt: Timestamp                      // 수정일시
}
```

#### `attendance_student_pins/{studentId}`
학생 PIN (bcrypt 해시)
```typescript
{
  id: string                                // studentId와 동일
  userId: string                            // 소유자 ID
  studentId: string                         // 학생 ID
  studentName: string                       // 학생 이름
  pinHash: string                           // bcrypt 해시된 PIN
  actualPin: string                         // 실제 PIN (관리자 확인용)
  isActive: boolean                         // 활성 상태
  isLocked: boolean                         // 잠금 상태
  failedAttempts: number                    // 실패 횟수
  lastFailedAt?: Timestamp                  // 마지막 실패 시각 (optional)
  lastChangedAt: Timestamp                  // 마지막 변경 시각
  lastUsedAt?: Timestamp                    // 마지막 사용 시각 (optional)
  changeHistory?: [                         // 변경 이력 (optional)
    {
      changedAt: Timestamp
      changedBy: string
    }
  ]
  createdAt: Timestamp                      // 생성일시
  updatedAt: Timestamp                      // 수정일시
}
```

#### `shared_schedules/{scheduleId}`
시간표 공유 링크
```typescript
{
  shareToken: string                        // UUID 공유 토큰
  timetableId: string                       // 시간표 ID

  // 권한 설정
  permissions: {
    canEdit: boolean                        // 편집 가능 여부
    canView: boolean                        // 조회 가능 여부
    canComment: boolean                     // 댓글 가능 여부
  }

  // 접근 설정
  accessSettings: {
    requireName: boolean                    // 이름 요구 여부
    requireEmail: boolean                   // 이메일 요구 여부
    maxContributions?: number               // 최대 기여 횟수 (optional)
  }

  // 링크 설정
  linkSettings: {
    isActive: boolean                       // 활성 상태
    expiresAt?: Timestamp                   // 만료일시 (optional)
    createdAt: Timestamp                    // 생성일시
    lastUsedAt?: Timestamp                  // 마지막 사용 시각 (optional)
    usageCount: number                      // 사용 횟수
  }

  title?: string                            // 제목 (optional)
  description?: string                      // 설명 (optional)
  createdAt: Timestamp                      // 생성일시
  updatedAt: Timestamp                      // 수정일시
}
```

#### `schedule_contributions/{contributionId}`
시간표 기여/제출
```typescript
{
  shareToken: string                        // 공유 토큰
  timetableId: string                       // 시간표 ID

  // 기여자 정보
  contributor: {
    name?: string                           // 이름 (optional)
    email?: string                          // 이메일 (optional)
    ipAddress: string                       // IP 주소
  }

  // 기여 내용
  contributions: [
    {
      dayOfWeek: string                     // 요일
      timeSlots: [
        {
          startTime: string                 // "HH:mm" 형식
          endTime: string                   // "HH:mm" 형식
          subject: string                   // 과목명
          type: "class" | "self_study"      // 슬롯 유형
          color?: string                    // 색상 (optional)
          note?: string                     // 메모 (optional)
        }
      ]
    }
  ]

  status: "pending" | "approved" | "rejected" | "applied"  // 처리 상태
  appliedAt?: Timestamp                     // 적용일시 (optional)
  submittedAt: Timestamp                    // 제출일시
  processedAt?: Timestamp                   // 처리일시 (optional)
  processedBy?: string                      // 처리자 (optional)
}
```

#### `seats/{seatId}`
좌석 정보
```typescript
{
  seatNumber: string                        // 좌석 번호
  location: {
    x: number                               // X 좌표
    y: number                               // Y 좌표
  }
  status: "available" | "occupied" | "maintenance"  // 좌석 상태
  createdAt: Timestamp                      // 생성일시
  updatedAt: Timestamp                      // 수정일시
}
```

#### `seat_assignments/{assignmentId}`
좌석 배정
```typescript
{
  seatId: string                            // 좌석 ID
  assignedAt: Timestamp                     // 배정일시
  expiresAt?: Timestamp                     // 만료일시 (optional)
  status: "active" | "expired" | "cancelled"  // 배정 상태
  updatedAt: Timestamp                      // 수정일시
}
```

#### `seat_layouts/{layoutId}`
좌석 레이아웃
```typescript
{
  name: string                              // 레이아웃 이름
  layout: {
    seats: [
      {
        id: string                          // 좌석 ID
        position: {
          x: number                         // X 위치
          y: number                         // Y 위치
        }
        size: {
          width: number                     // 너비
          height: number                    // 높이
        }
      }
    ]
    dimensions: {
      width: number                         // 전체 너비
      height: number                        // 전체 높이
    }
  }
  createdAt: Timestamp                      // 생성일시
  updatedAt: Timestamp                      // 수정일시
}
```

#### `class_sections/{sectionId}`
학급 정보
```typescript
{
  name: string                              // 학급명
  description?: string                      // 설명 (optional)
  schedule: {
    startTime: string                       // "HH:mm" 형식
    endTime: string                         // "HH:mm" 형식
    daysOfWeek: number[]                    // 요일 배열 (0=일요일, 6=토요일)
  }
  createdAt: Timestamp                      // 생성일시
  updatedAt: Timestamp                      // 수정일시
}
```

#### `attendance_summaries/{summaryId}`
출석 통계
```typescript
{
  period: string                            // 기간 (예: "2025-01")
  totalDays: number                         // 총 일수
  presentDays: number                       // 출석 일수
  absentDays: number                        // 결석 일��
  lateDays: number                          // 지각 일수
  earlyLeaveDays: number                    // 조퇴 일수
  attendanceRate: number                    // 출석률 (0-100)
  createdAt: Timestamp                      // 생성일시
  updatedAt: Timestamp                      // 수정일시
}
```

#### `settings/preferences`
사용자 설정 (단일 문서)
```typescript
{
  notifications: {
    attendance: boolean                     // 출석 알림
    schedule: boolean                       // 일정 알림
    announcements: boolean                  // 공지 알림
  }
  preferences: {
    theme: "light" | "dark"                 // 테마
    language: string                        // 언어 코드
  }
  createdAt: Timestamp                      // 생성일시
  updatedAt: Timestamp                      // 수정일시
}
```

---

## Data Isolation Architecture

### 핵심 원칙
1. **모든 데이터는 `users/{userId}` 하위에 격리**
2. **Google Auth 기반 userId로 완전 분리**
3. **Cloud Functions에서 `request.auth.uid` 검증 필수**
4. **각 사용자는 자신의 데이터만 접근 가능**
5. **Firestore Security Rules로 데이터 접근 제어**

### 보안 검증 흐름
```
1. 클라이언트 요청 → Firebase Auth 토큰
2. Cloud Function 실행 → request.auth.uid 추출
3. Firestore 쿼리 → users/{request.auth.uid}/... 경로만 접근
4. 데이터 반환 → 본인 데이터만 응답
```
