# 출석 관리 시스템 사용 설명서

> **버전**: 1.0 (2025-11-12)
> **대상**: 학원 관리자 및 운영자

---

## 📋 목차

1. [시스템 개요](#시스템-개요)
2. [초기 설정](#초기-설정)
3. [일일 운영 절차](#일일-운영-절차)
4. [학생 PIN 관리](#학생-pin-관리)
5. [출석 상태 이해하기](#출석-상태-이해하기)
6. [자동화 시스템](#자동화-시스템)
7. [문제 해결](#문제-해결)

---

## 시스템 개요

### 핵심 기능

이 출석 시스템은 **슬롯 기반 자동화 출석 관리**를 제공합니다:

- ✅ **자동 출석 레코드 생성**: 매일 새벽 2시, 학생 시간표 기반으로 자동 생성
- ✅ **PIN 기반 셀프 체크인**: 학생이 자신의 PIN으로 등원/하원 처리
- ✅ **좌석 배치 관리**: 그룹별 좌석 배치도 생성 및 학생 할당
- ✅ **자동 결석 처리**: 미등원 학생 자동 감지 및 결석 확정
- ✅ **실시간 출석 현황**: 좌석 배치도에서 실시간 출석 상태 확인

### 시스템 구조

```
좌석 배치도 (Seat Layout)
  └─ 그룹 (Groups): A그룹, B그룹 등
      └─ 좌석 (Seats): 각 좌석별 ID
          └─ 학생 할당 (Seat Assignment)
              └─ 학생 시간표 (Student Timetable)
                  └─ 출석 레코드 (Attendance Records)
```

---

## 초기 설정

### 1단계: 좌석 배치도 생성

1. **출석 관리 페이지 접속**
   - 좌측 메뉴에서 "출석 관리" 클릭

2. **배치도 생성**
   - `+ 배치도 추가` 버튼 클릭
   - 배치도 이름 입력 (예: "2025년 1월 배치도")
   - 그룹 추가:
     - 그룹명: A그룹, B그룹 등
     - 행(rows) × 열(cols) 입력 (예: 3행 × 4열 = 12석)
     - 드래그로 그룹 위치 조정
   - `생성` 버튼 클릭

3. **그룹 편집 (선택사항)**
   - 배치도 하단 `🏗️ 그룹 편집` 버튼
   - 그룹 추가/삭제/이름 변경/크기 조정
   - `저장` 후 페이지 새로고침 (자동)

### 2단계: 학생 좌석 할당

1. **좌석 클릭**
   - 배치도에서 빈 좌석 클릭
   - "좌석 할당" 모달 자동 오픈

2. **학생 선택**
   - 드롭다운에서 학생 선택
   - ⚠️ **중요**: 학생에게 **활성 시간표**가 있어야 할당 가능
   - 시간표가 없는 학생은 선택 불가

3. **할당 확인**
   - `할당` 버튼 클릭
   - 좌석에 학생 이름 표시됨

### 3단계: 학생 PIN 생성

1. **PIN 관리 모달 열기**
   - 상단 `📱 PIN 관리` 버튼 클릭

2. **링크 생성**
   - `+ 새 링크 생성` 클릭
   - 제목 입력 (예: "2025년 1월 출석")
   - 설명 입력 (선택)
   - 배치도 선택
   - `생성` 버튼

3. **링크 URL 복사**
   - 생성된 링크 URL 복사
   - QR 코드 생성 (자동 표시)
   - 학생들에게 공유 (예: 입구에 QR 코드 부착)

4. **학생별 PIN 설정**
   - 좌석 클릭 → 학생 상세 사이드바 오픈
   - `PIN 관리` 버튼 클릭
   - `PIN 생성` 클릭 → 자동으로 6자리 PIN 생성
   - 생성된 PIN을 학생에게 개별 전달

---

## 일일 운영 절차

### 아침 (개원 전)

#### 자동 처리 (새벽 2시)
- ✅ **시스템이 자동으로 수행**
- 모든 학생의 오늘 시간표 슬롯별 출석 레코드 생성
- 상태: `scheduled` (예정)

**관리자 작업 불필요**

---

### 오전 (개원 시간)

#### 1. 출석 현황 확인
- 출석 관리 페이지 접속
- 좌석 배치도에서 실시간 상태 확인:
  - 🟦 **파란색**: 예정 (scheduled)
  - 🟢 **초록색**: 등원 완료 (checked_in)
  - 🟡 **노란색**: 미등원 (not_arrived)
  - 🔴 **빨간색**: 결석 (absent_excused/absent_unexcused)

#### 2. 학생 셀프 체크인
- 학생이 QR 코드 스캔 또는 링크 접속
- PIN 입력 화면에서 자신의 6자리 PIN 입력
- `등원 체크` 버튼 클릭
- ✅ 시스템이 자동으로 상태 변경: `scheduled` → `checked_in`

#### 3. 수업 시작 시간 자동 처리
- **예시**: 9시 수업 시작
  - 9시 정각: 시스템이 자동 실행
  - `scheduled` 상태인 학생 → `not_arrived` (미등원) 전환
  - 9시 이후 PIN 입력 시 → `checked_in` + 지각 표시 (`isLate: true`)

#### 4. 수동 출석 처리 (필요 시)
- 좌석 클릭 → 학생 상세 사이드바
- `수동 등원` 버튼 클릭
- 사유 입력 (선택)
- 확인

---

### 오후/저녁 (운영 중)

#### 1. 하원 체크
- 학생이 동일한 링크/QR 코드 접속
- PIN 입력
- `하원 체크` 버튼 클릭
- ✅ 상태 변경: `checked_in` → `checked_out`

#### 2. 조퇴 처리
- 예정 시간보다 30분 이상 일찍 하원 시 자동으로 조퇴 표시
- `isEarlyLeave: true` + 조퇴 시간(분) 기록

#### 3. 사유 결석 처리
- 학부모 연락 등으로 사유 결석 확인 시
- 좌석 클릭 → 학생 상세 사이드바
- `출석 상태 변경` → `사유결석` 선택
- 결석 사유 입력 (예: "병원 진료")
- 메모 추가 (선택)
- 저장

---

### 저녁 (마감)

#### 자동 결석 처리 (10분마다 실행)
- **수업 종료 + 30분 + 5분 유예** 경과 시
- `not_arrived` → `absent_unexcused` (무단결석) 자동 확정

**예시**:
```
수업 시간: 09:00 - 12:00
종료 시간: 12:00
유예 종료: 12:35 (12:00 + 30분 + 5분)
결석 확정: 12:35 이후 자동 처리
```

---

## 학생 PIN 관리

### PIN 생성

1. **자동 생성 방식 (권장)**
   - 학생 상세 사이드바 → `PIN 관리` → `PIN 생성`
   - 시스템이 6자리 랜덤 PIN 자동 생성
   - 관리자가 학생에게 전달

2. **수동 입력 방식**
   - `PIN 변경` 클릭
   - 4-6자리 숫자 직접 입력
   - 중복 체크 후 저장

### PIN 보안

- ✅ **bcrypt 해싱**: PIN은 암호화되어 저장
- ✅ **중복 방지**: 같은 PIN을 다른 학생이 사용할 수 없음
- ✅ **자동 잠금**: 5회 연속 실패 시 자동 잠금
- ✅ **잠금 해제**: 관리자만 PIN 잠금 해제 가능

### PIN 잠금 해제

1. 학생 상세 사이드바 → `PIN 관리`
2. "잠금 상태" 표시 확인
3. `잠금 해제` 버튼 클릭
4. 실패 횟수 초기화

---

## 출석 상태 이해하기

### 6가지 상태

| 상태 | 영문 | 설명 | 색상 | 자동/수동 |
|------|------|------|------|-----------|
| 예정 | `scheduled` | 새벽 2시 배치로 생성된 초기 상태 | 🟦 파란색 | 자동 |
| 등원 | `checked_in` | 학생이 PIN으로 등원 체크 완료 | 🟢 초록색 | 자동/수동 |
| 하원 | `checked_out` | 학생이 PIN으로 하원 체크 완료 | ⚫ 회색 | 자동/수동 |
| 미등원 | `not_arrived` | 수업 시작 시간 지났지만 등원 안 함 | 🟡 노란색 | 자동 |
| 사유결석 | `absent_excused` | 관리자가 결석 사유 입력 | 🟠 주황색 | 수동 |
| 무단결석 | `absent_unexcused` | 유예 기간 경과 후 자동 확정 | 🔴 빨간색 | 자동 |

### 상태 전환 흐름

```
새벽 2시: scheduled (예정)
            ↓
       ┌────┴────┐
       ↓         ↓
   checked_in  not_arrived (수업 시작 시간)
       ↓         ↓
   checked_out  absent_unexcused (유예 기간 초과)
```

### 특수 케이스

1. **지각 체크인**
   - 수업 시작 후 PIN 입력 시
   - `not_arrived` → `checked_in`
   - `isLate: true` + 지각 시간(분) 기록

2. **유예 기간 체크인**
   - 수업 종료 후 30분 + 5분 이내 PIN 입력
   - 지각으로 처리되지만 결석은 면함

3. **사유 결석 변경**
   - 관리자가 언제든지 `사유결석`으로 변경 가능
   - 사유 및 메모 필수 입력

---

## 자동화 시스템

### 배치 작업 스케줄

| 작업명 | 실행 시간 | 주기 | 설명 |
|--------|-----------|------|------|
| 출석 레코드 생성 | 새벽 2:00 | 1회/일 | 오늘 시간표 기반 레코드 생성 |
| 미등원 전환 | 09:00 - 23:00 | 매 시 00분/30분 | scheduled → not_arrived |
| 무단결석 확정 | 00:00 - 23:50 | 10분마다 | not_arrived → absent_unexcused |

### 최적화 기술

**99.8% Firestore 읽기 감소**

- ✅ **정밀 시간 매칭**: 09:00 수업은 09:00에만 조회
- ✅ **인덱스 활용**: `date` + `status` + `expectedArrivalTime` 복합 인덱스
- ✅ **배치 횟수 감소**: 144회/일 → 29회/일

### 성능 지표

- **일일 학생 500명 기준**:
  - 생성: 2,500개 레코드 (평균 5슬롯/학생)
  - 읽기: 145회 (기존 72,000회 대비 99.8% ↓)
  - 쓰기: 2,500 + α (상태 변경)

---

## 문제 해결

### Q1: 학생이 PIN을 잊어버렸어요

**해결**:
1. 출석 관리 페이지 → 학생 좌석 클릭
2. 학생 상세 사이드바 → `PIN 관리`
3. **현재 PIN 표시됨** (`actualPin` 필드)
4. 학생에게 다시 알려주기

또는:
1. `PIN 변경` → 새 PIN 발급
2. 새 PIN을 학생에게 전달

---

### Q2: PIN 입력 시 "잠겨있습니다" 오류

**원인**: 5회 연속 실패

**해결**:
1. 학생 상세 사이드바 → `PIN 관리`
2. `잠금 해제` 버튼 클릭
3. 실패 횟수 초기화
4. 학생에게 정확한 PIN 재확인 후 입력 요청

---

### Q3: 학생이 등원했는데 "미등원" 표시

**원인**:
- PIN 입력 안 함
- 또는 수업 시작 시간 이후 등원

**해결**:
1. **지금 체크인** (유예 기간 내):
   - 학생에게 지금 PIN 입력하도록 요청
   - 자동으로 `checked_in` 처리 (지각 표시)

2. **수동 체크인** (유예 기간 경과):
   - 좌석 클릭 → `수동 등원` 버튼
   - 사유 입력 (예: "PIN 입력 누락")

---

### Q4: 시간표 없는 학생을 좌석에 할당할 수 없어요

**원인**: 출석 시스템은 시간표 기반이므로 활성 시간표 필수

**해결**:
1. 시간표 관리 페이지 이동
2. 해당 학생 선택
3. 시간표 생성 또는 기존 시간표 활성화
4. 출석 관리 페이지로 돌아와서 좌석 할당

---

### Q5: 출석 체크 링크가 작동하지 않아요

**확인 사항**:
1. **링크 활성 상태**:
   - `📱 PIN 관리` → 링크 목록
   - "활성" 토글 확인 (켜져 있어야 함)

2. **링크 만료일**:
   - 만료일 경과 시 재생성 필요

3. **브라우저 캐시**:
   - 학생에게 브라우저 새로고침 요청

**해결**:
- 링크 재생성:
  - `+ 새 링크 생성`
  - 새 QR 코드 출력 및 재부착

---

### Q6: 그룹 편집 후 좌석 할당이 사라졌어요

**원인**: 그룹 편집 시 좌석 ID가 재생성되므로 기존 할당과 불일치

**현재 동작**: 의도된 설계 (초기 세팅 전용)

**권장 사항**:
1. **초기 세팅 시에만 그룹 편집**
2. 학생 할당 완료 후에는 그룹 편집 자제
3. 필요 시:
   - 그룹 편집 → 페이지 새로고침
   - 학생들 다시 할당

---

### Q7: 출석 통계가 이상해요 (중복 카운트)

**원인**: 학생이 당일 여러 슬롯(수업) 있는 경우

**해결**: 시스템이 자동 처리
- `isLatestSession: true` 필터링
- 최신 세션만 통계에 포함
- 관리자 작업 불필요

---

### Q8: 새벽 2시 배치 작업 실패

**확인**:
1. Firebase Console → Functions → Logs
2. `createDailyAttendanceRecords` 로그 확인
3. 오류 메시지 확인

**일반적 원인**:
- 시간표 없는 학생
- 비활성 날짜 (일요일 등)
- Firestore 권한 문제

**해결**:
- 로그에서 SKIP 메시지 확인
- 해당 학생 시간표 점검

---

## 추가 팁

### 효율적인 운영

1. **QR 코드 부착 위치**:
   - 출입구 입/퇴실 동선에 각각 부착
   - 크기: A4 용지 크기 권장
   - 라벨: "등원 체크" / "하원 체크"

2. **PIN 관리 전략**:
   - 학기 초 일괄 생성 후 학생별 개별 전달
   - PIN 카드 제작 (이름 + PIN) 후 배포
   - 분실 시 즉시 변경 가능

3. **모니터링 시간**:
   - 수업 시작 10분 후: 미등원 학생 확인
   - 수업 종료 시간: 하원 체크 현황 확인
   - 유예 기간 전: 사유 결석 처리

4. **백업 절차**:
   - 출석 데이터는 Firestore에 자동 저장
   - Firebase Console에서 일별 백업 권장
   - 출석부 엑셀 다운로드 (향후 기능 추가 예정)

---

## 시스템 요구사항

- **브라우저**: Chrome, Safari, Edge 최신 버전
- **모바일**: iOS 14+, Android 10+
- **네트워크**: 안정적인 인터넷 연결
- **권한**: Firebase 인증된 관리자 계정

---

## 지원 및 문의

**문제 발생 시**:
1. 이 가이드의 "문제 해결" 섹션 확인
2. Firebase Console → Functions → Logs 확인
3. 개발팀 문의 (기술 지원 필요 시)

---

**마지막 업데이트**: 2025-11-12
**문서 버전**: 1.0
