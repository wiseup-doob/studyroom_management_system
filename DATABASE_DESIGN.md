# WiseUp 관리 시스템 - 데이터베이스 설계 (사용자 기반 격리 버전)

## 📋 개요

WiseUp 관리 시스템은 Firebase Firestore를 기반으로 한 NoSQL 데이터베이스를 사용합니다. 이 시스템은 **사용자 기반 데이터 격리(User-based Data Isolation) 아키텍처**로 설계되어, 각 사용자는 자신의 데이터만 접근할 수 있습니다.

이 버전에서는 각 로그인한 사용자가 개별적인 데이터 공간을 가지며, 다른 사용자의 데이터에는 접근할 수 없습니다. 사용자는 Firebase Auth의 UID를 통해 자신만의 **개인 데이터에만 접근 권한**을 가집니다.

## 🎯 시스템 요구사항

### 주요 기능

  - 개인 사용자 관리 (Google 계정 연동 로그인)
  - 개인 출석 관리
  - **고급 시간표 관리** (2레이어 구조: 등원/하원 + 세부일정)
  - **시간표 링크 공유** (외부 사용자가 일정 입력 가능)
  - **자동 자습시간 채우기** (빈 시간대를 자동으로 자습으로 설정)
  - 개인 좌석 관리 (배정 및 배치도)

### 인증 시스템

  - **Google 계정 연동**: Firebase Auth Google Provider를 사용한 소셜 로그인
  - **사용자 (User)**: Google 로그인 시 Firebase Auth UID를 기반으로 개인 데이터 공간을 가집니다
  - **데이터 격리**: 각 사용자는 완전히 독립적인 데이터 공간을 가지며, 다른 사용자의 데이터는 볼 수 없습니다
  - **협업 기능**: 시간표 링크 공유를 통한 제한적 외부 접근 허용

## 🗄️ 데이터베이스 구조

### 기본 구조

사용자 기반 격리 아키텍처로 변경되었습니다. 각 사용자는 자신만의 독립적인 데이터 공간을 가집니다.

```
users (컬렉션)
└── {userId} (문서) - Firebase Auth UID (Google 계정)
    ├── (사용자 기본 정보 필드들)
    ├── attendance_records (하위 컬렉션)
    ├── timetables (하위 컬렉션) ← 2레이어 구조로 확장
    ├── shared_schedules (하위 컬렉션) ← 시간표 링크 공유 관리
    ├── schedule_contributions (하위 컬렉션) ← 외부 기여 데이터 수집
    ├── seats (하위 컬렉션)
    ├── seat_assignments (하위 컬렉션)
    ├── seat_layouts (하위 컬렉션)
    ├── class_sections (하위 컬렉션)
    ├── attendance_summaries (하위 컬렉션)
    └── settings (하위 컬렉션)
```

-----

### 1\. 사용자 컬렉션 (users) - Google 계정 기반

`users/{userId}`

각 사용자의 기본 정보를 저장하는 루트 컬렉션입니다. 문서 ID는 Firebase Auth UID(Google 계정)와 동일합니다.

```typescript
interface User {
  authUid: string;                 // Firebase Auth UID (Google 계정)
  name: string;                    // Google 계정 이름
  email: string;                   // Google 이메일
  profilePicture?: string;         // Google 프로필 사진 URL
  googleId: string;               // Google 계정 ID
  isActive: boolean;               // 사용자 상태 (활성, 비활성)
  createdAt: FirestoreTimestamp;   // 생성일
  updatedAt: FirestoreTimestamp;   // 수정일
}
```

### 2\. 출석 기록 컬렉션 (attendance\_records)

`users/{userId}/attendance_records`

각 사용자의 개인 출석 기록을 저장합니다.

```typescript
type AttendanceStatus = 'present' | 'absent' | 'late' | 'early_leave';

interface AttendanceRecord {
  date: string;                    // 출석 날짜 (YYYY-MM-DD 형식)
  status: AttendanceStatus;        // 출석 상태
  seatId?: string;                 // 배정된 좌석 ID
  checkInTime?: FirestoreTimestamp; // 입실 시간
  checkOutTime?: FirestoreTimestamp; // 퇴실 시간
  notes?: string;                  // 출석 관련 메모
  createdAt: FirestoreTimestamp;   // 생성일
  updatedAt: FirestoreTimestamp;   // 수정일
}
```

### 3\. 시간표 컬렉션 (timetables) - 2레이어 구조

`users/{userId}/timetables`

각 사용자의 고급 시간표를 저장합니다. 등원/하원 기본 틀과 세부 일정을 분리하여 관리합니다.

```typescript
type DayOfWeek = 'monday' | 'tuesday' | 'wednesday' | 'thursday' | 'friday' | 'saturday' | 'sunday';

interface Timetable {
  name: string;                    // 시간표 이름

  // 1차 레이어: 등원/하원 기본 틀
  basicSchedule: {
    arrivalTime: string;           // 등원 시간 "09:00"
    departureTime: string;         // 하원 시간 "18:00"
    daysOfWeek: DayOfWeek[];       // 활성 요일 ["monday", "tuesday", ...]
    timeSlotInterval: number;      // 시간 단위 (분) 기본값: 30
  };

  // 2차 레이어: 구체적인 일정
  detailedSchedule: {
    [dayOfWeek: string]: {         // "monday", "tuesday" 등
      timeSlots: {
        startTime: string;         // "10:00"
        endTime: string;           // "11:30"
        subject: string;           // "수학", "영어", "자습"
        type: 'class' | 'self_study'; // 수업/자습 구분
        isAutoGenerated: boolean;  // 자동생성된 자습시간인지
        color?: string;            // 시간표 표시 색상
      }[];
    };
  };

  // 공유 기능
  isShared: boolean;              // 공유 활성화 여부
  shareToken?: string;            // 링크 공유용 고유 토큰
  shareSettings: {
    allowEdit: boolean;           // 외부 편집 허용
    allowView: boolean;           // 외부 조회 허용
    expiresAt?: FirestoreTimestamp; // 공유 만료일
  };

  // 자동 채우기 설정
  autoFillSettings: {
    enabled: boolean;             // 자동 자습시간 채우기 활성화
    defaultSubject: string;       // 기본 자습 과목명 "자습"
    fillEmptySlots: boolean;      // 빈 시간 자동 채우기
  };

  isActive: boolean;               // 활성 상태
  createdAt: FirestoreTimestamp;   // 생성일
  updatedAt: FirestoreTimestamp;   // 수정일
}
```

### 4\. 시간표 공유 컬렉션 (shared\_schedules)

`users/{userId}/shared_schedules`

시간표 링크 공유를 관리합니다. 외부 사용자가 시간표에 일정을 추가할 수 있도록 하는 기능입니다.

```typescript
interface SharedSchedule {
  shareToken: string;             // 고유 공유 토큰 (UUID)
  timetableId: string;           // 원본 시간표 문서 ID

  // 공유 설정
  permissions: {
    canEdit: boolean;            // 편집 권한 (일정 추가/수정)
    canView: boolean;            // 조회 권한
    canComment: boolean;         // 댓글 권한
  };

  // 접근 제어
  accessSettings: {
    requireName: boolean;        // 이름 입력 필수 여부
    requireEmail: boolean;       // 이메일 입력 필수 여부
    maxContributions?: number;   // 최대 기여 횟수
  };

  // 링크 관리
  linkSettings: {
    isActive: boolean;           // 링크 활성 상태
    expiresAt?: FirestoreTimestamp; // 만료일 (선택적)
    createdAt: FirestoreTimestamp;  // 생성일
    lastUsedAt?: FirestoreTimestamp; // 마지막 사용일
    usageCount: number;          // 사용 횟수
  };

  // 메타데이터
  title?: string;                // 공유 링크 제목
  description?: string;          // 공유 링크 설명
  createdAt: FirestoreTimestamp; // 생성일
  updatedAt: FirestoreTimestamp; // 수정일
}
```

### 5\. 일정 기여 컬렉션 (schedule\_contributions)

`users/{userId}/schedule_contributions`

외부 사용자가 공유 링크를 통해 추가한 일정 데이터를 수집합니다.

```typescript
interface ScheduleContribution {
  shareToken: string;            // 사용된 공유 토큰
  timetableId: string;          // 대상 시간표 ID

  // 기여자 정보
  contributor: {
    name?: string;               // 기여자 이름 (선택적)
    email?: string;              // 기여자 이메일 (선택적)
    ipAddress: string;           // IP 주소 (보안용)
  };

  // 기여한 일정들
  contributions: {
    dayOfWeek: string;           // "monday", "tuesday" 등
    timeSlots: {
      startTime: string;         // "10:00"
      endTime: string;           // "11:30"
      subject: string;           // "수학 과외"
      type: 'class' | 'self_study';
      color?: string;            // 표시 색상
      note?: string;             // 추가 메모
    }[];
  }[];

  // 처리 상태
  status: 'pending' | 'approved' | 'rejected' | 'applied'; // 처리 상태
  appliedAt?: FirestoreTimestamp; // 시간표에 적용된 시각

  // 메타데이터
  submittedAt: FirestoreTimestamp; // 제출 시각
  processedAt?: FirestoreTimestamp; // 처리 시각
  processedBy?: string;          // 처리자 (시간표 소유자)
}
```

### 6\. 좌석 정보 컬렉션 (seats)

`users/{userId}/seats`

각 사용자의 개인 좌석 정보를 저장합니다.

```typescript
interface Seat {
  seatNumber: string;              // 좌석 번호
  location: {                      // 좌석 위치
    x: number;
    y: number;
  };
  status: 'available' | 'occupied' | 'maintenance'; // 좌석 상태
  createdAt: FirestoreTimestamp;   // 생성일
  updatedAt: FirestoreTimestamp;   // 수정일
}
```

### 5\. 좌석 배정 컬렉션 (seat\_assignments)

`users/{userId}/seat_assignments`

각 사용자의 좌석 배정 기록을 저장합니다.

```typescript
type AssignmentStatus = 'active' | 'expired' | 'cancelled';

interface SeatAssignment {
  seatId: string;                  // 배정된 좌석 ID
  assignedAt: FirestoreTimestamp;  // 배정 시각
  expiresAt?: FirestoreTimestamp;  // 만료 시각
  status: AssignmentStatus;        // 배정 상태
  updatedAt: FirestoreTimestamp;   // 수정일
}
```

### 6\. 좌석 배치도 컬렉션 (seat\_layouts)

`users/{userId}/seat_layouts`

각 사용자의 개인 좌석 배치도를 저장합니다.

```typescript
interface SeatLayout {
  name: string;                    // 배치도 이름
  layout: {
    seats: {
      id: string;
      position: { x: number; y: number };
      size: { width: number; height: number };
    }[];
    dimensions: {
      width: number;
      height: number;
    };
  };
  createdAt: FirestoreTimestamp;   // 생성일
  updatedAt: FirestoreTimestamp;   // 수정일
}
```

### 7\. 학급 정보 컬렉션 (class\_sections)

`users/{userId}/class_sections`

각 사용자의 개인 학급 정보를 저장합니다.

```typescript
interface ClassSection {
  name: string;                    // 학급명
  description?: string;            // 학급 설명
  schedule: {
    startTime: string;             // 시작 시간
    endTime: string;               // 종료 시간
    daysOfWeek: number[];          // 요일 (0: 일요일, 1: 월요일, ...)
  };
  createdAt: FirestoreTimestamp;   // 생성일
  updatedAt: FirestoreTimestamp;   // 수정일
}
```

### 8\. 출석 요약 컬렉션 (attendance\_summaries)

`users/{userId}/attendance_summaries`

각 사용자의 출석 통계를 저장합니다.

```typescript
interface AttendanceSummary {
  period: string;                  // 집계 기간 (YYYY-MM)
  totalDays: number;               // 총 일수
  presentDays: number;             // 출석 일수
  absentDays: number;              // 결석 일수
  lateDays: number;                // 지각 일수
  earlyLeaveDays: number;          // 조퇴 일수
  attendanceRate: number;          // 출석률 (%)
  createdAt: FirestoreTimestamp;   // 생성일
  updatedAt: FirestoreTimestamp;   // 수정일
}
```

### 9\. 설정 컬렉션 (settings)

`users/{userId}/settings`

각 사용자의 개인 설정을 저장합니다.

```typescript
interface UserSettings {
  notifications: {
    attendance: boolean;           // 출석 알림
    schedule: boolean;             // 스케줄 알림
    announcements: boolean;        // 공지사항 알림
  };
  preferences: {
    theme: 'light' | 'dark';       // 테마 설정
    language: string;              // 언어 설정
  };
  createdAt: FirestoreTimestamp;   // 생성일
  updatedAt: FirestoreTimestamp;   // 수정일
}
```

-----

## 🔐 보안 규칙 (Firestore Rules) - 사용자 기반 격리

사용자 기반 격리 아키텍처로 변경되면서 보안 규칙이 **매우 단순하고 강력**해졌습니다. 각 사용자는 자신의 UID와 일치하는 데이터에만 접근할 수 있습니다.

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 사용자 기반 데이터 격리 - 로그인한 계정별로 데이터 분리

    // 사용자별 데이터 - uid 기반 격리
    match /users/{userId} {
      // 사용자는 본인 데이터만 접근 가능
      allow read, write: if request.auth != null &&
        request.auth.uid == userId;

      // 출석 기록 - 해당 사용자만 접근 가능
      match /attendance_records/{recordId} {
        allow read, write: if request.auth != null &&
          request.auth.uid == userId;
      }

      // 시간표 - 해당 사용자만 접근 가능
      match /timetables/{timetableId} {
        allow read, write: if request.auth != null &&
          request.auth.uid == userId;
      }

      // 좌석 배정 - 해당 사용자만 접근 가능
      match /seat_assignments/{assignmentId} {
        allow read, write: if request.auth != null &&
          request.auth.uid == userId;
      }

      // 좌석 정보 - 해당 사용자만 접근 가능
      match /seats/{seatId} {
        allow read, write: if request.auth != null &&
          request.auth.uid == userId;
      }

      // 학급 정보 - 해당 사용자만 접근 가능
      match /class_sections/{sectionId} {
        allow read, write: if request.auth != null &&
          request.auth.uid == userId;
      }

      // 출석 요약 - 해당 사용자만 접근 가능
      match /attendance_summaries/{summaryId} {
        allow read, write: if request.auth != null &&
          request.auth.uid == userId;
      }

      // 좌석 배치도 - 해당 사용자만 접근 가능
      match /seat_layouts/{layoutId} {
        allow read, write: if request.auth != null &&
          request.auth.uid == userId;
      }

      // 설정 - 해당 사용자만 접근 가능
      match /settings/{settingId} {
        allow read, write: if request.auth != null &&
          request.auth.uid == userId;
      }

      // 시간표 공유 링크 관리 - 본인만 접근 가능
      match /shared_schedules/{scheduleId} {
        allow read, write: if request.auth != null &&
          request.auth.uid == userId;
      }

      // 외부 일정 기여 수집 - 본인만 접근 가능
      match /schedule_contributions/{contributionId} {
        allow read, write: if request.auth != null &&
          request.auth.uid == userId;
      }

      // 기타 하위 컬렉션 - 기본 권한 적용
      match /{subCollection}/{docId} {
        allow read, write: if request.auth != null &&
          request.auth.uid == userId;
      }
    }

    // 루트 레벨 컬렉션 접근 차단 (보안 강화)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
```

### 동작 방식

#### 기본 인증 및 데이터 격리

1.  사용자가 Google 계정으로 로그인하면 Firebase Auth에서 고유한 UID를 발급받습니다.
2.  모든 개인 데이터는 `/users/{uid}/` 경로 하위에 저장됩니다.
3.  Firestore 보안 규칙은 `request.auth.uid`와 접근하려는 경로의 `{userId}`가 일치하는지만 확인합니다.
4.  일치하면 해당 사용자의 모든 데이터에 접근이 허용되고, 일치하지 않으면 완전히 차단됩니다.

#### 고급 시간표 기능 동작

5.  **2레이어 시간표**:
      * 1차 레이어에서 등원/하원 시간과 기본 틀을 설정
      * 2차 레이어에서 구체적인 일정을 시간대별로 관리
6.  **자동 자습시간 채우기**:
      * 등원 시간부터 하원 시간까지 설정된 시간 단위로 분할
      * 기존 일정이 없는 빈 시간대를 자동으로 "자습" 항목으로 채움
      * `isAutoGenerated: true` 플래그로 수동/자동 생성 구분

#### 시간표 공유 시스템 동작

7.  **공유 링크 생성**: 사용자가 시간표 공유를 활성화하면 고유 토큰 생성
8.  **외부 접근**: 공유 링크를 받은 사람이 별도 인증 없이 일정 입력 가능
9.  **기여 데이터 수집**: 외부 입력 데이터는 `schedule_contributions`에 임시 저장
10. **승인 프로세스**: 시간표 소유자가 기여 데이터를 검토 후 승인/거부
11. **자동 적용**: 승인된 일정은 원본 시간표에 자동 반영, 나머지 시간은 자습으로 채움

#### 보안 및 접근 제어

12. **완전한 격리**: 각 사용자는 자신의 데이터만 접근 가능
13. **공유 예외 처리**: 시간표 공유는 Cloud Functions를 통해 제한적으로 처리
14. **커스텀 클레임 불필요**: Google 인증만으로 모든 권한 관리 완료

-----

## 🚀 최종 컬렉션 구조 (11개) - 사용자 기반 격리 + 고급 시간표

각 사용자별로 독립적인 하위 컬렉션을 가지는 구조입니다:

1.  **users** - 사용자 기본 정보 (루트 컬렉션, Google 계정)
2.  **attendance\_records** - 개인 출석 기록 (`users/{userId}/attendance_records`)
3.  **timetables** - 고급 시간표 2레이어 구조 (`users/{userId}/timetables`)
4.  **shared\_schedules** - 시간표 공유 링크 관리 (`users/{userId}/shared_schedules`)
5.  **schedule\_contributions** - 외부 일정 기여 수집 (`users/{userId}/schedule_contributions`)
6.  **seats** - 개인 좌석 정보 (`users/{userId}/seats`)
7.  **seat\_assignments** - 개인 좌석 배정 (`users/{userId}/seat_assignments`)
8.  **seat\_layouts** - 개인 좌석 배치도 (`users/{userId}/seat_layouts`)
9.  **class\_sections** - 개인 학급 정보 (`users/{userId}/class_sections`)
10. **attendance\_summaries** - 개인 출석 요약 (`users/{userId}/attendance_summaries`)
11. **settings** - 개인 설정 (`users/{userId}/settings`)

### 아키텍처 개선 요약

#### 🔐 보안 & 격리

  * **완전한 데이터 격리**: 각 사용자는 자신의 데이터에만 접근 가능하며, 다른 사용자의 데이터는 완전히 격리됩니다.
  * **단순한 보안 규칙**: Firebase Auth UID 비교만으로 모든 보안이 해결됩니다.
  * **커스텀 클레임 불필요**: 추가적인 권한 관리나 클레임 설정이 전혀 필요하지 않습니다.

#### 🚀 확장성 & 성능

  * **확장성**: 사용자가 증가해도 각자 독립적인 데이터 공간을 가지므로 확장성이 뛰어납니다.
  * **개발 단순화**: 복잡한 권한 분기나 다중 테넌트 로직이 불필요하여 개발이 매우 단순해집니다.
  * **데이터 무결성**: 사용자별 완전 격리로 데이터 오염이나 혼재 가능성이 전혀 없습니다.

#### 📅 고급 시간표 기능

  * **2레이어 시간표**: 등원/하원 기본 틀과 세부 일정을 분리하여 유연한 관리
  * **자동 자습시간 채우기**: 빈 시간대를 자동으로 "자습" 항목으로 채우는 지능형 기능
  * **링크 공유 시스템**: 외부 사용자가 시간표에 일정을 추가할 수 있는 협업 기능
  * **기여 데이터 관리**: 외부에서 입력된 일정을 승인/거부할 수 있는 관리 시스템

#### 🔗 인증 & 소셜 로그인

  * **Google 계정 연동**: Firebase Auth Google Provider를 통한 간편한 소셜 로그인
  * **프로필 정보 자동 동기화**: Google 계정의 이름, 이메일, 프로필 사진 자동 연동
  * **보안 강화**: Google의 2단계 인증 등 기존 보안 체계 활용