rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 멀티테넌트 아키텍처 - academyId 기반 데이터 격리
    
    // 관리자 컬렉션 - 슈퍼 관리자만 접근 가능
    match /admins/{adminId} {
      allow read: if request.auth != null && 
        request.auth.token.super_admin == true;
      allow write: if request.auth != null && 
        request.auth.token.super_admin == true;
    }
    
    // 학원별 데이터 - academyId 기반 격리
    match /academies/{academyId} {
      // 학원 데이터 접근 권한 검증
      allow read, write: if request.auth != null && 
        request.auth.token.academyId == academyId;
      
      // 학생 데이터 - 관리자 또는 본인만 접근 가능
      match /students/{studentId} {
        allow read: if request.auth != null && 
          request.auth.token.academyId == academyId &&
          (request.auth.token.admin == true || 
           request.auth.uid == get(/databases/$(database)/documents/academies/$(academyId)/students/$(studentId)).data.authUid);
        allow write: if request.auth != null && 
          request.auth.token.academyId == academyId && 
          request.auth.token.admin == true;
      }
      
      // 출석 기록 - 관리자 또는 해당 학생만 접근 가능
      match /attendance_records/{recordId} {
        allow read: if request.auth != null && 
          request.auth.token.academyId == academyId &&
          (request.auth.token.admin == true ||
           request.auth.uid == get(/databases/$(database)/documents/academies/$(academyId)/students/$(resource.data.studentId)).data.authUid);
        allow write: if request.auth != null && 
          request.auth.token.academyId == academyId && 
          request.auth.token.admin == true;
      }
      
      // 학생 시간표 - 관리자 또는 해당 학생만 접근 가능
      match /student_timetables/{studentId} {
        allow read: if request.auth != null && 
          request.auth.token.academyId == academyId &&
          (request.auth.token.admin == true ||
           request.auth.uid == get(/databases/$(database)/documents/academies/$(academyId)/students/$(studentId)).data.authUid);
        allow write: if request.auth != null && 
          request.auth.token.academyId == academyId && 
          request.auth.token.admin == true;
      }
      
      // 좌석 배정 - 관리자 또는 해당 학생만 접근 가능
      match /seat_assignments/{assignmentId} {
        allow read: if request.auth != null && 
          request.auth.token.academyId == academyId &&
          (request.auth.token.admin == true ||
           request.auth.uid == get(/databases/$(database)/documents/academies/$(academyId)/students/$(resource.data.studentId)).data.authUid);
        allow write: if request.auth != null && 
          request.auth.token.academyId == academyId && 
          request.auth.token.admin == true;
      }
      
      // 좌석 정보 - 해당 학원 사용자만 접근 가능
      match /seats/{seatId} {
        allow read: if request.auth != null && 
          request.auth.token.academyId == academyId;
        allow write: if request.auth != null && 
          request.auth.token.academyId == academyId && 
          request.auth.token.admin == true;
      }
      
      // 학급 정보 - 해당 학원 사용자만 접근 가능
      match /class_sections/{sectionId} {
        allow read: if request.auth != null && 
          request.auth.token.academyId == academyId;
        allow write: if request.auth != null && 
          request.auth.token.academyId == academyId && 
          request.auth.token.admin == true;
      }
      
      // 출석 요약 - 해당 학원 사용자만 접근 가능
      match /attendance_summaries/{summaryId} {
        allow read: if request.auth != null && 
          request.auth.token.academyId == academyId;
        allow write: if request.auth != null && 
          request.auth.token.academyId == academyId && 
          request.auth.token.admin == true;
      }
      
      // 좌석 배치도 - 해당 학원 사용자만 접근 가능
      match /seat_layouts/{layoutId} {
        allow read: if request.auth != null && 
          request.auth.token.academyId == academyId;
        allow write: if request.auth != null && 
          request.auth.token.academyId == academyId && 
          request.auth.token.admin == true;
      }
      
      // 학원 설정 - 해당 학원 관리자만 접근 가능
      match /settings/{settingId} {
        allow read: if request.auth != null && 
          request.auth.token.academyId == academyId;
        allow write: if request.auth != null && 
          request.auth.token.academyId == academyId && 
          request.auth.token.admin == true;
      }
      
      // 기타 하위 컬렉션 - 기본 권한 적용
      match /{subCollection}/{docId} {
        allow read: if request.auth != null && 
          request.auth.token.academyId == academyId;
        allow write: if request.auth != null && 
          request.auth.token.academyId == academyId && 
          request.auth.token.admin == true;
      }
    }
    
    // 루트 레벨 컬렉션 접근 차단 (보안 강화)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
