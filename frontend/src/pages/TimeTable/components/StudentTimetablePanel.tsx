/**
 * StudentTimetablePanel.tsx - í•™ìƒ ì‹œê°„í‘œ íŒ¨ë„ ì»´í¬ë„ŒíŠ¸ (ê²€ì€ìƒ‰/í•˜ì–€ìƒ‰ í…Œë§ˆ)
 *
 * Phase 2 êµ¬í˜„:
 * - í•™ìƒ ì‹œê°„í‘œ í‘œì‹œ
 * - ì‹œê°„í‘œ ê·¸ë¦¬ë“œ ë Œë”ë§
 * - ì‹œê°„í‘œ ìƒì„±/ìˆ˜ì • ê¸°ëŠ¥
 */

import React, { useState } from 'react';
import { StudentWithTimetable, StudentTimetableData, TimeSlot, TimeSlotType } from '../../../types/student';
import { studentTimetableService } from '../../../services/backendService';
import TimeSlotEditModal from './TimeSlotEditModal';
import ShareLinkModal from './ShareLinkModal';
import EditLinkManagementModal from './EditLinkManagementModal';
import './StudentTimetablePanel.css';

interface StudentTimetablePanelProps {
  student: StudentWithTimetable;
  timetable: StudentTimetableData | null;
  onTimetableUpdate: (timetable: StudentTimetableData) => void;
  onTimetableCreate: () => void;
}

const StudentTimetablePanel: React.FC<StudentTimetablePanelProps> = ({
  student,
  timetable,
  onTimetableUpdate,
  onTimetableCreate
}) => {
  // ì‹œê°„í‘œ í¸ì§‘ ëª¨ë‹¬ ìƒíƒœ
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);
  // ê³µìœ  ë§í¬ ëª¨ë‹¬ ìƒíƒœ
  const [isShareLinkModalOpen, setIsShareLinkModalOpen] = useState(false);
  // í¸ì§‘ ë§í¬ ê´€ë¦¬ ëª¨ë‹¬ ìƒíƒœ
  const [isEditLinkManagementModalOpen, setIsEditLinkManagementModalOpen] = useState(false);

  // ì‹œê°„í‘œ í¸ì§‘ ëª¨ë‹¬ ì—´ê¸°
  const handleEditTimetable = () => {
    setIsEditModalOpen(true);
  };

  // ëª¨ë‹¬ ë‹«ê¸°
  const closeEditModal = () => {
    setIsEditModalOpen(false);
  };

  // ê³µìœ  ë§í¬ ìƒì„± í•¸ë“¤ëŸ¬
  const handleCreateShareLink = () => {
    setIsShareLinkModalOpen(true);
  };

  // ê³µìœ  ë§í¬ ëª¨ë‹¬ ë‹«ê¸°
  const closeShareLinkModal = () => {
    setIsShareLinkModalOpen(false);
  };

  // í¸ì§‘ ë§í¬ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
  const handleEditLinkManagement = () => {
    setIsEditLinkManagementModalOpen(true);
  };

  // í¸ì§‘ ë§í¬ ê´€ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
  const closeEditLinkManagementModal = () => {
    setIsEditLinkManagementModalOpen(false);
  };

  // ìˆ˜ì—… ì¶”ê°€ í•¸ë“¤ëŸ¬
  const handleAddClass = async (classData: {
    day: string;
    startTime: string;
    endTime: string;
    subject: string;
    teacher?: string;
    location?: string;
    type: TimeSlotType;
    color: string;
    notes?: string;
  }) => {
    if (!timetable) return;

    try {
      // ìƒˆ ì‹œê°„í‘œ ë°ì´í„° ìƒì„±
      const newTimetable = { ...timetable };
      const daySchedule = newTimetable.detailedSchedule[classData.day];
      
      // ìš”ì¼ ìŠ¤ì¼€ì¤„ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš° ì´ˆê¸°í™”
      if (!daySchedule) {
        newTimetable.detailedSchedule[classData.day] = { timeSlots: [] };
      }
      
      // ìƒˆ ìˆ˜ì—… ì¶”ê°€
      const newSlot: TimeSlot = {
        id: Date.now().toString(),
        startTime: classData.startTime,
        endTime: classData.endTime,
        subject: classData.subject,
        teacher: classData.teacher || undefined,
        location: classData.location || undefined,
        type: classData.type,
        color: classData.color,
        notes: classData.notes || undefined,
        isAutoGenerated: false
      };

      newTimetable.detailedSchedule[classData.day].timeSlots.push(newSlot);
      newTimetable.detailedSchedule[classData.day].timeSlots.sort((a, b) => a.startTime.localeCompare(b.startTime));

      // ë°±ì—”ë“œì— ì €ì¥
      await studentTimetableService.updateStudentTimetable(timetable.id, {
        detailedSchedule: newTimetable.detailedSchedule
      });

      // ì‹œê°„í‘œ ì—…ë°ì´íŠ¸
      onTimetableUpdate(newTimetable);
    } catch (error) {
      console.error('ìˆ˜ì—… ì¶”ê°€ ì‹¤íŒ¨:', error);
      throw error;
    }
  };

  // ìˆ˜ì—… ì‚­ì œ í•¸ë“¤ëŸ¬
  const handleDeleteClass = async (day: string, slotId: string) => {
    if (!timetable) return;

    try {
      const newTimetable = { ...timetable };
      const daySchedule = newTimetable.detailedSchedule[day];
      
      // ìš”ì¼ ìŠ¤ì¼€ì¤„ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš° ì²˜ë¦¬
      if (!daySchedule) {
        throw new Error('í•´ë‹¹ ìš”ì¼ì˜ ìŠ¤ì¼€ì¤„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
      
      daySchedule.timeSlots = daySchedule.timeSlots.filter(slot => slot.id !== slotId);

      // ë°±ì—”ë“œì— ì €ì¥
      await studentTimetableService.updateStudentTimetable(timetable.id, {
        detailedSchedule: newTimetable.detailedSchedule
      });

      // ì‹œê°„í‘œ ì—…ë°ì´íŠ¸
      onTimetableUpdate(newTimetable);
    } catch (error) {
      console.error('ìˆ˜ì—… ì‚­ì œ ì‹¤íŒ¨:', error);
      throw error;
    }
  };
  // ì‹œê°„ëŒ€ ìƒì„± í•¨ìˆ˜ (9ì‹œë¶€í„° 24ì‹œê¹Œì§€, 30ë¶„ ê°„ê²©)
  const generateTimeSlots = () => {
    const slots = [];
    const startHour = 9; // 9ì‹œë¶€í„° ì‹œì‘
    const endHour = 24;  // 24ì‹œê¹Œì§€
    const interval = 30; // 30ë¶„ ê°„ê²©
    
    for (let hour = startHour; hour < endHour; hour++) {
      for (let min = 0; min < 60; min += interval) {
        const timeString = `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
        const minutes = hour * 60 + min;
        const nextMinutes = minutes + interval;
        
        slots.push({
          time: timeString,
          startMinutes: minutes,
          endMinutes: nextMinutes
        });
      }
    }
    
    return slots;
  };

  // íŠ¹ì • ìš”ì¼ì˜ ìˆ˜ì—…ë“¤ì„ ì‹œê°„ëŒ€ë³„ë¡œ ë§¤í•‘í•˜ëŠ” í•¨ìˆ˜ (ìë™ ììŠµ ì±„ìš°ê¸° í¬í•¨)
  const getTimeSlotMapping = (day: string) => {
    const daySchedule = timetable?.detailedSchedule[day];
    const timeSlots = generateTimeSlots();
    const mapping: { [key: string]: any } = {};
    const occupiedSlots = new Set<number>(); // ìˆ˜ì—…ì´ ì°¨ì§€í•˜ëŠ” ëª¨ë“  ìŠ¬ë¡¯ ì¶”ì 

    // ì‹¤ì œ ìˆ˜ì—…ë“¤ì„ ë§¤í•‘
    if (daySchedule) {
      daySchedule.timeSlots.forEach(slot => {
        const slotStartMinutes = timeToMinutes(slot.startTime);
        const slotEndMinutes = timeToMinutes(slot.endTime);
        
        // ì´ ìˆ˜ì—…ì´ ì‹œì‘ë˜ëŠ” ì²« ë²ˆì§¸ ì‹œê°„ ìŠ¬ë¡¯ ì°¾ê¸°
        const startSlotIndex = timeSlots.findIndex(ts => 
          ts.startMinutes <= slotStartMinutes && ts.endMinutes > slotStartMinutes
        );
        
        if (startSlotIndex !== -1) {
          // ì´ ìˆ˜ì—…ì´ ëª‡ ê°œì˜ ì‹œê°„ ìŠ¬ë¡¯ì„ ì°¨ì§€í•˜ëŠ”ì§€ ê³„ì‚° (ì„¸ë¡œë¡œ)
          const spanCount = Math.ceil((slotEndMinutes - slotStartMinutes) / 30); // ê³ ì • 30ë¶„ ê°„ê²©
          
          // ìˆ˜ì—…ì´ ì°¨ì§€í•˜ëŠ” ëª¨ë“  ìŠ¬ë¡¯ì„ occupiedSlotsì— ì¶”ê°€
          for (let i = 0; i < spanCount; i++) {
            occupiedSlots.add(startSlotIndex + i);
          }
          
          mapping[startSlotIndex] = {
            ...slot,
            spanCount: Math.max(1, spanCount)
          };
        }
      });
    }

    // ë“±ì›ì‹œê°„ ë²”ìœ„ ë‚´ì—ì„œë§Œ ììŠµ ì±„ìš°ê¸° (ìš”ì¼ë³„, í™œì„±í™”ëœ ìš”ì¼ë§Œ)
    const basicDaySchedule = timetable?.basicSchedule?.dailySchedules?.[day as keyof typeof timetable.basicSchedule.dailySchedules];

    // isActiveê°€ trueì¸ ìš”ì¼ë§Œ ììŠµ ì±„ìš°ê¸°
    if (basicDaySchedule?.isActive) {
      const arrivalMinutes = timeToMinutes(basicDaySchedule.arrivalTime);
      const departureMinutes = timeToMinutes(basicDaySchedule.departureTime);

      // ë¹ˆ ìŠ¬ë¡¯ì„ ììŠµìœ¼ë¡œ ìë™ ì±„ìš°ê¸° (ë“±ì›ì‹œê°„ ë²”ìœ„ ë‚´ì—ì„œë§Œ)
      timeSlots.forEach((timeSlot, index) => {
        // ë“±ì›ì‹œê°„ ë²”ìœ„ ë‚´ì´ê³ , ìˆ˜ì—…ì´ ì°¨ì§€í•˜ì§€ ì•ŠëŠ” ìŠ¬ë¡¯ë§Œ ììŠµìœ¼ë¡œ ì±„ìš°ê¸°
        if (timeSlot.startMinutes >= arrivalMinutes &&
            timeSlot.startMinutes < departureMinutes &&
            !occupiedSlots.has(index)) {

          mapping[index] = {
            id: `self-study-${day}-${index}`,
            startTime: timeSlot.time,
            endTime: timeSlots[index + 1]?.time || '24:00',
            subject: 'ììŠµ',
            type: 'self_study',
            color: '#9E9E9E',
            isAutoGenerated: true,
            spanCount: 1
          };
        }
      });
    }

    return mapping;
  };

  // ì‹œê°„ì„ ë¶„ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
  const timeToMinutes = (time: string): number => {
    const [hours, minutes] = time.split(':').map(Number);
    return hours * 60 + minutes;
  };

  // ìš”ì¼ ë°°ì—´
  const daysOfWeek = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
  const dayNames = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];

  // ì‹œê°„í‘œê°€ ì—†ëŠ” ê²½ìš°
  if (!timetable) {
    return (
      <div className="stp-main-panel">
        <div className="stp-panel-header">
          <div className="stp-student-info">
            <h2>{student.name}</h2>
            <p className="stp-student-details">{student.grade}</p>
          </div>
          <div className="stp-header-actions">
            <button
              className="stp-btn-create"
              onClick={onTimetableCreate}
            >
              + ì‹œê°„í‘œ ìƒì„±
            </button>
          </div>
        </div>
        <div className="stp-empty-state">
          <h3>ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤</h3>
          <p>ìƒˆë¡œìš´ ì‹œê°„í‘œë¥¼ ìƒì„±í•´ë³´ì„¸ìš”.</p>
        </div>
      </div>
    );
  }

  const timeSlots = generateTimeSlots();

  return (
    <div className="stp-main-panel">
      {/* í—¤ë” */}
      <div className="stp-panel-header">
        <div className="stp-student-info">
          <h2>{student.name}</h2>
          <p className="stp-student-details">
            {student.grade} â€¢ {timetable.name}
          </p>
        </div>
        <div className="stp-header-actions">
          <button
            className="stp-btn-share-link"
            onClick={handleCreateShareLink}
            title="í•™ìƒ í¸ì§‘ ë§í¬ ìƒì„±"
          >
            ğŸ”— í¸ì§‘ ë§í¬
          </button>
          <button
            className="stp-btn-edit-link-management"
            onClick={handleEditLinkManagement}
            title="í¸ì§‘ ë§í¬ ê´€ë¦¬"
          >
            âš™ï¸ ë§í¬ ê´€ë¦¬
          </button>
          <button
            className="stp-btn-edit-timetable"
            onClick={handleEditTimetable}
            title="ì‹œê°„í‘œ í¸ì§‘"
          >
            âœï¸ ì‹œê°„í‘œ í¸ì§‘
          </button>
          <button
            className="stp-btn-refresh"
            onClick={() => window.location.reload()}
            title="ìƒˆë¡œê³ ì¹¨"
          >
            ğŸ”„
          </button>
        </div>
      </div>

      {/* ì‹œê°„í‘œ ê·¸ë¦¬ë“œ */}
      <div className="stp-timetable-container">
        <table className="stp-timetable-grid">
          <thead>
            <tr>
              <th className="stp-time-header">ì‹œê°„</th>
              {daysOfWeek.map((day, index) => (
                <th key={day} className="stp-day-header">
                  {dayNames[index]}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {timeSlots.map((slot, slotIndex) => (
              <tr key={slotIndex}>
                <td className="stp-time-header">
                  {slot.time}
                </td>
                {daysOfWeek.map((day) => {
                  const timeSlotMapping = getTimeSlotMapping(day);
                  const timeSlot = timeSlotMapping[slotIndex];
                  
                  // ì´ ì…€ì´ ìˆ˜ì—…ì˜ ì‹œì‘ì ì¸ì§€ í™•ì¸
                  if (timeSlot) {
                    console.log('TimeSlot color:', timeSlot.color, 'for subject:', timeSlot.subject);
                    return (
                      <td 
                        key={day} 
                        className="stp-time-slot stp-slot-with-content"
                        rowSpan={timeSlot.spanCount}
                        style={{ 
                          backgroundColor: timeSlot.color || '#f0f0f0',
                          borderColor: timeSlot.color || '#2196f3'
                        }}
                      >
                        <div className="stp-slot-content">
                          {timeSlot.type !== 'self_study' && (
                            <div className="stp-slot-subject">{timeSlot.subject}</div>
                          )}
                          <div className="stp-slot-time">
                            {timeSlot.startTime} - {timeSlot.endTime}
                          </div>
                          <div className={`stp-slot-type ${timeSlot.type === 'external' ? 'external-class' : timeSlot.type}`}>
                            {timeSlot.type === 'class' ? 'ìˆ˜ì—…' : 
                             timeSlot.type === 'self_study' ? 'ììŠµ' : 'ì™¸ë¶€ìˆ˜ì—…'}
                          </div>
                        </div>
                      </td>
                    );
                  }
                  
                  // ì´ ì…€ì´ ë‹¤ë¥¸ ìˆ˜ì—…ì— ì˜í•´ ì´ë¯¸ ì°¨ì§€ë˜ì—ˆëŠ”ì§€ í™•ì¸
                  const isOccupied = Object.keys(timeSlotMapping).some(startIndex => {
                    const slot = timeSlotMapping[startIndex];
                    const startIdx = parseInt(startIndex);
                    return slotIndex > startIdx && slotIndex < startIdx + slot.spanCount;
                  });
                  
                  if (isOccupied) {
                    return null; // ì´ë¯¸ ë‹¤ë¥¸ ìˆ˜ì—…ì´ ì°¨ì§€í•œ ì…€ì´ë¯€ë¡œ ë Œë”ë§í•˜ì§€ ì•ŠìŒ
                  }
                  
                  // ë¹ˆ ì…€
                  return (
                    <td key={day} className="stp-time-slot">
                      <div className="stp-slot-content">
                        <div className="stp-slot-subject">-</div>
                      </div>
                    </td>
                  );
                })}
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* TimeSlotEditModal */}
      {isEditModalOpen && timetable && (
        <TimeSlotEditModal
          isOpen={isEditModalOpen}
          onClose={closeEditModal}
          onAddClass={handleAddClass}
          onDeleteClass={handleDeleteClass}
          timetable={timetable}
        />
      )}

      {/* ShareLinkModal */}
      {isShareLinkModalOpen && timetable && (
        <ShareLinkModal
          isOpen={isShareLinkModalOpen}
          onClose={closeShareLinkModal}
          student={student}
          timetable={timetable}
        />
      )}

      {/* EditLinkManagementModal */}
      <EditLinkManagementModal
        isOpen={isEditLinkManagementModalOpen}
        onClose={closeEditLinkManagementModal}
        studentId={student.id}
        studentName={student.name}
      />
    </div>
  );
};

export default StudentTimetablePanel;